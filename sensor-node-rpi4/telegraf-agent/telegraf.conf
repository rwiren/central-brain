# ==============================================================================
# TELEGRAF CONFIGURATION v1.1.0
# ==============================================================================
# Author:      RW / Central Brain Project
# Description: Collects sensor node telemetry (GPS, Hardware Health) and pushes
#              to the Central Brain InfluxDB.
#
# ðŸ“‹ CHANGELOG:
#   v1.0: Initial configuration with standard system metrics.
#   v1.1: (2025-12-01) Restored 'inputs.socket_listener' to capture detailed GPSD data.
#         Added 'inputs.exec' for custom GPS health script.
#         Tuned timeouts to prevent script execution gaps.
# ==============================================================================

[global_tags]
  # Tags added to all metrics (useful for filtering in Grafana)
  role = "sensor-node"
  location = "EFHK-Corridor"

[agent]
  # Collection Interval: Matches the 15s update rate of the Central Brain
  interval = "15s"
  round_interval = true
  
  # Jitter: Randomize collection slightly to prevent CPU spikes
  collection_jitter = "0s"
  
  # Flush Interval: How often to push data to InfluxDB
  flush_interval = "15s"
  flush_jitter = "0s"
  
  # Hostname: Overrides the Docker container ID with a readable name
  hostname = "RPi4-Sensor"
  omit_hostname = false

# ==============================================================================
# ðŸ“¤ OUTPUTS
# ==============================================================================

# Output to Central Brain (RPi5)
[[outputs.influxdb]]
  urls = ["http://192.168.1.134:8086"]
  database = "readsb"
  timeout = "5s"
  
  # User Agent helps identify this source in InfluxDB logs
  user_agent = "Telegraf-RPi4-Sensor"

# ==============================================================================
# ðŸ“¥ INPUTS: HARDWARE HEALTH
# ==============================================================================

# Monitor CPU Load & Temperature (Critical for outdoor enclosures)
[[inputs.cpu]]
  percpu = true
  totalcpu = true
  collect_cpu_time = false
  report_active = false

[[inputs.temp]]
  # RPi4 Temperature Sensor

[[inputs.mem]]
  # RAM Usage

[[inputs.disk]]
  # Disk Space (Prevent log filling)
  ignore_fs = ["tmpfs", "devtmpfs", "devfs", "iso9660", "overlay", "aufs", "squashfs"]

# ==============================================================================
# ðŸ“¥ INPUTS: GNSS & TIMING
# ==============================================================================

# 1. GPSD Socket Listener (THE FIX)
# Reads raw JSON stream from the local GPSD sidecar. 
# Provides TPV (Time-Position-Velocity) and SKY (Satellite) data.
[[inputs.socket_listener]]
  service_address = "tcp://localhost:2947"
  data_format = "json"
  json_name_key = "class"
  json_time_key = "time"
  json_time_format = "2006-01-02T15:04:05.000Z"
  tag_keys = ["mode", "device"]

# 2. Custom GPS Script Executor
# Runs the shell script to gather extra metadata not provided by socket.
[[inputs.exec]]
  commands = ["/usr/local/bin/gpsd_telegraf.sh"]
  
  # Timeout must be larger than the script execution time to avoid SIGKILL
  timeout = "10s"
  
  data_format = "json"
  name_override = "gps_data"
  
  [inputs.exec.tags]
    sensor_type = "u-blox_m8n"
