version: '2.1'

volumes:
  readsb-data:

services:
  # ==============================================================================
  # 1. HARDWARE ABSTRACTION LAYER
  # ==============================================================================
  
  # [GPS HARDWARE] Connects to USB Stick -> Outputs TCP 2000
  splitter:
    build: ./splitter
    privileged: true
    network_mode: host
    restart: always
    environment:
      - SERIAL_PORT=/dev/ttyACM0
      - BAUD_RATE=9600
      - TCP_PORT=2000

  # [GPS LOGIC] Connects to Splitter -> Outputs standard GPSD Port 2947
  gpsd:
    build: ./gpsd
    privileged: true
    network_mode: host
    restart: always
    depends_on:
      - splitter
    environment:
      - DEVICES=tcp://127.0.0.1:2000
      - GPSD_OPTIONS=-n -G

  # [SDR HARDWARE] Connects to Airspy/RTL-SDR -> Outputs Beast Port 30005
  dump1090-fa:
    build: ./dump1090-fa
    privileged: true
    network_mode: host
    restart: always
    environment:
      - DEVICE_LAT=${LAT}
      - DEVICE_LON=${LON}
    volumes:
      - readsb-data:/var/lib/readsb/pb

  # ==============================================================================
  # 2. LOGIC & TELEMETRY
  # ==============================================================================

  # [INTEGRITY MONITOR] Pushes GPS Error/Satellites to Central Brain
  telegraf-agent:
    build: ./telegraf-agent
    privileged: true
    network_mode: host
    restart: always
    depends_on:
      - splitter
      - gpsd

  # [HEALTH MONITOR] Pushes CPU/Temp/RAM to Central Brain
  system-observer:
    build: ./system-observer
    privileged: true
    network_mode: host
    restart: always
    environment:
      - INFLUX_HOST=192.168.1.134
      - INFLUX_PORT=8086
      - INFLUX_DB=readsb
      - DEVICE_NAME=RPi4-Sensor

  # [PRECISION TIMING] Multilateration Client
  mlat-client:
    build: ./mlat-client
    network_mode: host
    restart: always
    environment:
      - LAT=${LAT}
      - LON=${LON}
      - ALT=${ALT}
      - USER=rwiren
      - INPUT_HOST=127.0.0.1
      - INPUT_PORT=30005

  # ==============================================================================
  # 3. GLOBAL FEEDERS
  # ==============================================================================
  
  piaware:
    build: ./piaware
    privileged: true
    network_mode: host
    restart: always
    environment:
      - RECEIVER_HOST=127.0.0.1
      - RECEIVER_PORT=30005

  fr24feed:
    build: ./fr24feed
    privileged: true
    network_mode: host
    restart: always
    environment:
      - BEAST_HOST=127.0.0.1
      - BEAST_PORT=30005

  planefinder:
    build: ./planefinder
    privileged: true
    network_mode: host
    restart: always
    environment:
      - HOST=127.0.0.1
      - PORT=30005

  airnav-radar:
    build: ./airnav-radar
    privileged: true
    network_mode: host
    restart: always
    environment:
      - BEASTHOST=127.0.0.1
      - BEASTPORT=30005

  opensky-network:
    build: ./opensky-network
    privileged: true
    network_mode: host
    restart: always
    environment:
      - HOST=127.0.0.1
      - PORT=30005
