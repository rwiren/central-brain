version: '2.1'

volumes:
  influxdb-data:
  grafana-data:
  readsb-data:
  mosquitto-data:

services:
  # ============================================================================
  # 1. MQTT BROKER (Custom Build from ./mqtt folder)
  # ============================================================================
  mqtt:
    build: ./mqtt 
    network_mode: host
    restart: always
    volumes:
      - mosquitto-data:/mosquitto/data

  # ============================================================================
  # 2. AGGREGATOR (ReadsB - Net Only)
  # ============================================================================
  readsb:
    image: ghcr.io/sdr-enthusiasts/docker-readsb-protobuf:latest
    network_mode: host
    privileged: true
    restart: always
    environment:
      - TZ=Europe/Helsinki
      - READSB_NET_ONLY=true
      - READSB_NET_ENABLE=true
      - READSB_NET_CONNECTOR=192.168.1.152,30005,beast_in
      - READSB_NET_BUFFER=2
      - READSB_WRITE_JSON_EVERY=1
      - READSB_WEB_ENABLE=true
      - READSB_NET_BEAST_INPUT_PORT=30004
      - READSB_NET_BEAST_OUTPUT_PORT=30005
      - READSB_NET_SBS_OUTPUT_PORT=30003
      - READSB_LAT=${LAT}
      - READSB_LON=${LON}
    volumes:
      - readsb-data:/var/lib/readsb/pb

  # ============================================================================
  # 3. DATABASE (InfluxDB)
  # ============================================================================
  influxdb:
    image: influxdb:1.8
    network_mode: host
    restart: always
    environment:
      - INFLUXDB_DB=readsb
      - INFLUXDB_ADMIN_ENABLED=true
      - INFLUXDB_ADMIN_USER=${INFLUX_USER}
      - INFLUXDB_ADMIN_PASSWORD=${INFLUX_PASSWORD}
    volumes:
      - influxdb-data:/var/lib/influxdb

  # ============================================================================
  # 4. DASHBOARD (Grafana)
  # ============================================================================
  grafana:
    image: grafana/grafana:latest
    network_mode: host
    restart: always
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD}
      - GF_INSTALL_PLUGINS=grafana-clock-panel,grafana-worldmap-panel
    volumes:
      - grafana-data:/var/lib/grafana

  # ============================================================================
  # 5. DATA FEEDERS (Pushing readsb/OpenSky to InfluxDB)
  # ============================================================================
  adsb-feeders:
    build:
      context: ./adsb-feeders
      dockerfile: Dockerfile
    restart: always
    network_mode: host
    depends_on:
      - readsb
      - influxdb
    environment:
      - OPENSKY_CLIENT_ID=${OPENSKY_CLIENT_ID}
      - OPENSKY_CLIENT_SECRET=${OPENSKY_CLIENT_SECRET}

  # ============================================================================
  # 6. SPOOF DETECTOR (Security & Drift Analysis)
  # ============================================================================
  spoof-detector:
    build: ./spoof-detector
    restart: always
    network_mode: host
    depends_on:
      - readsb
      - mqtt
    environment:
      - OPENSKY_CLIENT_ID=${OPENSKY_CLIENT_ID}
      - OPENSKY_CLIENT_SECRET=${OPENSKY_CLIENT_SECRET}
      - MQTT_BROKER=192.168.1.134 
      - MQTT_PORT=1883
      - LOCAL_READSB_URL=http://192.168.1.152:8080/data/aircraft.json 
      - MY_LAT=${LAT}
      - MY_LON=${LON}

  # ============================================================================
  # 7. SYSTEM OBSERVER (Health & GPS Stats)
  # ============================================================================
  system-observer:
    build: ./system-observer
    privileged: true
    restart: always
    network_mode: host
    depends_on:
      - influxdb
    environment:
      - INFLUX_HOST=192.168.1.134
      - INFLUX_DB=readsb
      - DEVICE_NAME=Central-Brain

  # ============================================================================
  # 8. PHYSICS GUARD (Kinematic Integrity)
  # ============================================================================
  physics-guard:
    build: ./physics-guard
    restart: always
    network_mode: host
    depends_on:
      - influxdb
      - mqtt
    environment:
      - INFLUX_HOST=192.168.1.134
      - INFLUX_PORT=8086
      - INFLUX_DB=readsb
      - MQTT_BROKER=192.168.1.134
      - MQTT_PORT=1883
      - GRAFANA_HOST=192.168.1.134

  # ============================================================================
  # 9. RUNWAY TRACKER (EFHK Operations)
  # ============================================================================
  runway-tracker:
    build: ./runway-tracker
    restart: always
    network_mode: host
    depends_on:
      - readsb
      - influxdb
    environment:
      - INFLUX_HOST=192.168.1.134
      - INFLUX_PORT=8086
      - INFLUX_DB=readsb
      - SDR_HOST=127.0.0.1
      - SDR_PORT=8080
      - MQTT_BROKER=192.168.1.134 
      - TARGET_AIRPORT=EFHK
      - GAZETTEER_URL=http://192.168.1.134:3000/public/gazetteer/airports.geojson

  # ============================================================================
  # 10. FR24 INTELLIGENCE (Global Truth Data)
  # ============================================================================
  fr24-poller:
    build: ./fr24-poller
    restart: always
    network_mode: host
    depends_on:
      - influxdb
    environment:
      - INFLUX_HOST=192.168.1.134
      - INFLUX_DB=readsb
      - FR24_API_TOKEN=${FR24_API_TOKEN}
      - FR24_BOUNDS=60.6,59.9,24.3,25.5
