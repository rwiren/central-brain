version: '2.1'

volumes:
  influxdb-data:
  grafana-data:
  readsb-data:
  mosquitto-data:

services:
  # ============================================================================
  # 1. MQTT BROKER (Notifications & Alerts)
  # ============================================================================
  mqtt:
    image: eclipse-mosquitto:latest
    network_mode: host
    restart: always
    volumes:
      - mosquitto-data:/mosquitto/data
      # - ./mosquitto/config:/mosquitto/config # Uncomment if you add custom config

  # ============================================================================
  # 2. AGGREGATOR (ReadsB - Net Only)
  # ============================================================================
  readsb:
    image: ghcr.io/sdr-enthusiasts/docker-readsb-protobuf:latest
    network_mode: host
    privileged: true
    restart: always
    environment:
      - TZ=Europe/Helsinki
      
      # --- HARDWARE MODE: NETWORK ONLY ---
      - READSB_NET_ONLY=true
      - READSB_NET_ENABLE=true
      
      # --- SOURCE: RPi4 FEEDER ---
      # Connects to RPi4 (192.168.1.152) on port 30005 (Beast)
      - READSB_NET_CONNECTOR=192.168.1.152,30005,beast_in

      # --- SMOOTHING & PERFORMANCE ---
      - READSB_NET_BUFFER=2
      # Updates JSON faster for the Watchdog script
      - READSB_WRITE_JSON_EVERY=1
      
      # --- OUTPUTS ---
      - READSB_WEB_ENABLE=true
      - READSB_NET_BEAST_INPUT_PORT=30004
      - READSB_NET_BEAST_OUTPUT_PORT=30005
      - READSB_NET_SBS_OUTPUT_PORT=30003
      
      # --- LOCATION ---
      - READSB_LAT=${LAT}
      - READSB_LON=${LON}
    volumes:
      - readsb-data:/var/lib/readsb/pb

  # ============================================================================
  # 3. DATABASE (InfluxDB)
  # ============================================================================
  influxdb:
    image: influxdb:1.8
    network_mode: host
    restart: always
    environment:
      - INFLUXDB_DB=readsb
      - INFLUXDB_ADMIN_ENABLED=true
      - INFLUXDB_ADMIN_USER=${INFLUX_USER}
      - INFLUXDB_ADMIN_PASSWORD=${INFLUX_PASSWORD}
    volumes:
      - influxdb-data:/var/lib/influxdb

  # ============================================================================
  # 4. DASHBOARD (Grafana)
  # ============================================================================
  grafana:
    image: grafana/grafana:latest
    network_mode: host
    restart: always
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD}
      - GF_INSTALL_PLUGINS=grafana-clock-panel,grafana-worldmap-panel
    volumes:
      - grafana-data:/var/lib/grafana

  # ============================================================================
  # 5. DATA FEEDERS (Pushing readsb/OpenSky to InfluxDB)
  # ============================================================================
  adsb-feeders:
    build:
      context: ./adsb-feeders
      dockerfile: Dockerfile
    restart: always
    network_mode: host
    depends_on:
      - readsb
      - influxdb
    # MAPPING OAUTH2 CLIENT ID/SECRET
    environment:
      - OPENSKY_CLIENT_ID=${OPENSKY_CLIENT_ID}
      - OPENSKY_CLIENT_SECRET=${OPENSKY_CLIENT_SECRET}

  # ============================================================================
  # 6. WATCHDOG 2.0 (Spoof Detector + Physics + Runways)
  # ============================================================================
  spoof-detector:
    build: ./spoof-detector
    restart: always
    network_mode: host
    depends_on:
      - readsb
      - mqtt
    # FIXED: Standardized environment to List format (resolves YAML error)
    environment:
      # MAPPING OAUTH2 CLIENT ID/SECRET
      - OPENSKY_CLIENT_ID=${OPENSKY_CLIENT_ID}
      - OPENSKY_CLIENT_SECRET=${OPENSKY_CLIENT_SECRET}
      
      # Internal Connections (127.0.0.1 is correct for host network mode)
      - MQTT_BROKER=127.0.0.1
      - MQTT_PORT=1883
      # FIXED: Uses RPi4's IP address (solves the 404 error)
      - LOCAL_READSB_URL=http://192.168.1.152:8080/data/aircraft.json 
      
      # Geography
      - MY_LAT=${LAT}
      - MY_LON=${LON}

  # ============================================================================
  # 7. PHYSICS GUARD (Legacy Reference - Optional)
  # ============================================================================
  physics-guard:
    build: ./physics-guard
    restart: always
    network_mode: host
    environment:
      - READSB_HOST=127.0.0.1
      - READSB_PORT=30003
      - INFLUX_HOST=127.0.0.1
      - INFLUX_DB=readsb
      - INFLUX_USER=${INFLUX_USER}
      - INFLUX_PASSWORD=${INFLUX_PASSWORD}
