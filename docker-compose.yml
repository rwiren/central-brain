version: '2.1'

volumes:
  influxdb-data:
  grafana-data:
  readsb-data:
  mosquitto-data:

services:
  # ============================================================================
  # 1. MQTT BROKER (Notifications & Alerts)
  # ============================================================================
  mqtt:
    image: eclipse-mosquitto:latest
    network_mode: host
    restart: always
    volumes:
      - mosquitto-data:/mosquitto/data
      # - ./mosquitto/config:/mosquitto/config # Uncomment if you add custom config

  # ============================================================================
  # 2. AGGREGATOR (ReadsB - Net Only)
  # ============================================================================
  readsb:
    image: ghcr.io/sdr-enthusiasts/docker-readsb-protobuf:latest
    network_mode: host
    privileged: true
    environment:
      - TZ=Europe/Helsinki
      
      # --- HARDWARE MODE: NETWORK ONLY ---
      - READSB_NET_ONLY=true
      - READSB_NET_ENABLE=true
      
      # --- SOURCE: RPi4 FEEDER ---
      # Connects to RPi4 (1.152) on port 30005 (Beast)
      - READSB_NET_CONNECTOR=192.168.1.152,30005,beast_in

      # --- SMOOTHING & PERFORMANCE ---
      # Reduces "jitter" by buffering network packets slightly
      - READSB_NET_BUFFER=2
      # Updates JSON faster for the Watchdog script (default is 5s)
      - READSB_WRITE_JSON_EVERY=1
      
      # --- OUTPUTS ---
      - READSB_WEB_ENABLE=true
      - READSB_NET_BEAST_INPUT_PORT=30004
      - READSB_NET_BEAST_OUTPUT_PORT=30005
      - READSB_NET_SBS_OUTPUT_PORT=30003
      
      # --- LOCATION ---
      - READSB_LAT=${LAT}
      - READSB_LON=${LON}
      
      # --- INFLUXDB INTEGRATION ---
      - INFLUXDBURL=http://127.0.0.1:8086
      - INFLUXDBNAME=readsb
      - INFLUXDB_DB=readsb
      - INFLUXDBUSERNAME=${INFLUX_USER}
      - INFLUXDBPASSWORD=${INFLUX_PASSWORD}
    volumes:
      - readsb-data:/var/lib/readsb/pb

  # ============================================================================
  # 3. DATABASE (InfluxDB)
  # ============================================================================
  influxdb:
    image: influxdb:1.8
    network_mode: host
    environment:
      - INFLUXDB_DB=readsb
      - INFLUXDB_ADMIN_ENABLED=true
      - INFLUXDB_ADMIN_USER=${INFLUX_USER}
      - INFLUXDB_ADMIN_PASSWORD=${INFLUX_PASSWORD}
    volumes:
      - influxdb-data:/var/lib/influxdb

  # ============================================================================
  # 4. DASHBOARD (Grafana)
  # ============================================================================
  grafana:
    image: grafana/grafana:latest
    network_mode: host
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD}
      - GF_INSTALL_PLUGINS=grafana-clock-panel,grafana-worldmap-panel
    volumes:
      - grafana-data:/var/lib/grafana

  # ============================================================================
  # 5. WATCHDOG 2.0 (Spoof Detector + Physics + Runways)
  # ============================================================================
  spoof-detector:
    build: ./spoof-detector
    restart: always
    network_mode: host
    environment:
      # OpenSky Credentials (for global truth)
      - OPENSKY_USER=${OPENSKY_USERNAME}
      - OPENSKY_PASS=${OPENSKY_PASSWORD}
      
      # Internal Connections
      - MQTT_BROKER=127.0.0.1
      - MQTT_PORT=1883
      - LOCAL_READSB_URL=http://127.0.0.1:8080/data/aircraft.json
      
      # Geography
      - MY_LAT=${LAT}
      - MY_LON=${LON}

  # ============================================================================
  # 6. PHYSICS GUARD (Legacy Reference - Optional)
  # ============================================================================
  # Kept for reference, but logic is now inside spoof-detector.
  physics-guard:
    build: ./physics-guard
    restart: always
    network_mode: host
    environment:
      - READSB_HOST=127.0.0.1
      - READSB_PORT=30003
      - INFLUX_HOST=127.0.0.1
      - INFLUX_DB=readsb
      - INFLUX_USER=${INFLUX_USER}
      - INFLUX_PASSWORD=${INFLUX_PASSWORD}
