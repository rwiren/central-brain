version: '2.1'

volumes:
  influxdb-data:
  grafana-data:
  readsb-data:
  # mosquitto-data: # Commented out temporarily

services:
  # ============================================================================
  # 1. MQTT BROKER (REMOVED TEMPORARILY)
  # ============================================================================
  # mqtt:
  #   image: eclipse-mosquitto:latest
  #   network_mode: host
  #   restart: always
  #   volumes:
  #     - mosquitto-data:/mosquitto/data

  # ============================================================================
  # 2. AGGREGATOR (ReadsB - Net Only)
  # ============================================================================
  readsb:
    image: ghcr.io/sdr-enthusiasts/docker-readsb-protobuf:latest
    network_mode: host
    privileged: true
    environment:
      - TZ=Europe/Helsinki
      - READSB_NET_ONLY=true
      - READSB_NET_ENABLE=true
      
      # --- CRITICAL UPDATE: Connect to RPi4 ---
      # Pulls Beast data from RPi4 (192.168.1.134)
      - READSB_NET_CONNECTOR=192.168.1.134,30005,beast_in

      # --- CRITICAL UPDATE: Enable JSON API for Watchdog ---
      - READSB_WEB_ENABLE=true
      
      # Ports
      - READSB_NET_BEAST_INPUT_PORT=30004
      - READSB_NET_BEAST_OUTPUT_PORT=30005
      - READSB_NET_SBS_OUTPUT_PORT=30003
      
      # Location
      - READSB_LAT=${LAT}
      - READSB_LON=${LON}
      
      # --- INFLUXDB CONFIG ---
      - INFLUXDBURL=http://127.0.0.1:8086
      - INFLUXDBNAME=readsb
      - INFLUXDB_DB=readsb
      - INFLUXDBUSERNAME=${INFLUX_USER}
      - INFLUXDBPASSWORD=${INFLUX_PASSWORD}
    volumes:
      - readsb-data:/var/lib/readsb/pb

  # ============================================================================
  # 3. DATABASE (InfluxDB)
  # ============================================================================
  influxdb:
    image: influxdb:1.8
    network_mode: host
    environment:
      # Create the "readsb" database on startup
      - INFLUXDB_DB=readsb
      - INFLUXDB_ADMIN_ENABLED=true
      - INFLUXDB_ADMIN_USER=${INFLUX_USER}
      - INFLUXDB_ADMIN_PASSWORD=${INFLUX_PASSWORD}
    volumes:
      - influxdb-data:/var/lib/influxdb

  # ============================================================================
  # 4. DASHBOARD (Grafana)
  # ============================================================================
  grafana:
    image: grafana/grafana:latest
    network_mode: host
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD}
      - GF_INSTALL_PLUGINS=grafana-clock-panel,grafana-worldmap-panel
    volumes:
      - grafana-data:/var/lib/grafana

  # ============================================================================
  # 5. SPOOF DETECTOR (Python AI)
  # ============================================================================
  spoof-detector:
    build: ./spoof-detector
    restart: always
    network_mode: host
    environment:
      # OpenSky Credentials
      - OPENSKY_USER=${OPENSKY_USERNAME}
      - OPENSKY_PASS=${OPENSKY_PASSWORD}
      
      # Connection details matching the new watchdog.py
      - MQTT_BROKER=127.0.0.1
      - MQTT_PORT=1883
      # Connects to the local readsb web server we just enabled
      - LOCAL_READSB_URL=http://127.0.0.1:8080/data/aircraft.json
      
      # Coordinates for OpenSky bounding box
      - MY_LAT=${LAT}
      - MY_LON=${LON}

  # ============================================================================
  # 6. PHYSICS GUARD (Physics Engine)
  # ============================================================================
  physics-guard:
    build: ./physics-guard
    restart: always
    network_mode: host
    environment:
      # Still connects to port 30003 (SBS) which Readsb provides
      - READSB_HOST=127.0.0.1
      - READSB_PORT=30003
      - INFLUX_HOST=127.0.0.1
      - INFLUX_DB=readsb
      - INFLUX_USER=${INFLUX_USER}
      - INFLUX_PASSWORD=${INFLUX_PASSWORD}
