# ==============================================================================
# Project: Central Brain (The Core)
# Version: 3.7.0 (Fix: Telegraf Auth & Grafana Token)
# Device:  Raspberry Pi 5 (BalenaOS)
# ==============================================================================

version: '2.1'

volumes:
  influxdb-data:
  grafana-data:
  mosquitto-data:
  readsb-pb-data: 

services:

  # ---------------------------------------------------------------------------
  # 1. CORE INFRASTRUCTURE
  # ---------------------------------------------------------------------------

  influxdb:
    image: influxdb:1.8
    container_name: influxdb
    restart: always
    ports:
      - "8086:8086"
    volumes:
      - influxdb-data:/var/lib/influxdb
    environment:
      - INFLUXDB_DB=readsb
      - INFLUXDB_HTTP_LOG_ENABLED=false
      - INFLUXDB_HTTP_LOGGING_ENABLED=false
      - INFLUXDB_DATA_QUERY_LOG_ENABLED=false
      - INFLUXDB_UDP_ENABLED=false

  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    restart: always
    ports:
      - "3000:3000"
    volumes:
      - grafana-data:/var/lib/grafana
    depends_on:
      - influxdb
    environment:
      - GF_INSTALL_PLUGINS=grafana-clock-panel,grafana-worldmap-panel
      # [FIX] Prevent log spam "token needs to be rotated"
      - GF_AUTH_TOKEN_ROTATION_INTERVAL_MINUTES=1440

  mqtt:
    build: ./mqtt
    container_name: mqtt
    restart: always
    ports:
      - "1883:1883"
    volumes:
      - mosquitto-data:/mosquitto/data

  # [MONITORING] RPi 5 Self-Health
  telegraf:
    build: ./telegraf
    restart: always
    privileged: true
    labels:
      io.balena.features.balena-socket: '1'
      io.balena.features.procfs: '1'
    environment:
      - HOST_ETC=/host/etc
      - HOST_PROC=/proc
      - HOST_SYS=/sys
      - HOST_MOUNT_PREFIX=/
      # [FIX] Connect Telegraf to InfluxDB with Auth
      - INFLUX_URL=http://influxdb:8086
      - INFLUX_DB=readsb
      - SENSOR_ID=central-brain
      # Variables passed from Dashboard
      - INFLUX_TOKEN=${INFLUX_TOKEN}
      - INFLUX_USER=${INFLUX_USER}
      - INFLUX_PASSWORD=${INFLUX_PASSWORD}

  # ---------------------------------------------------------------------------
  # 2. VISUALIZATION
  # ---------------------------------------------------------------------------

  readsb:
    image: ghcr.io/sdr-enthusiasts/docker-readsb-protobuf:latest
    restart: always
    volumes:
      - readsb-pb-data:/var/globe_history
    environment:
      - TZ=Europe/Helsinki
      - READSB_DEVICE_TYPE=none
      - READSB_NET_ONLY=true
      - READSB_NET_CONNECTOR=192.168.1.153,30005,beast_in;192.168.1.9,30005,beast_in
      - READSB_LAT=60.319555
      - READSB_LON=24.830819
      # [FIX] Filter out "underground" aircraft noise
      - READSB_FILTER_PERSISTENCE=true
    ports:
      - "30005:30005" 
      - "30004:30004"

  tar1090:
    image: ghcr.io/sdr-enthusiasts/docker-tar1090:latest
    restart: always
    ports:
      - "8080:80"
    volumes:
      - readsb-pb-data:/var/globe_history
    environment:
      - TZ=Europe/Helsinki
      - BEASTHOST=readsb
      - LAT=60.319555
      - LON=24.830819
      - TITLE=Central Brain (Fused Feed)
      - TAR1090_DEFAULTCENTERLAT=60.319555
      - TAR1090_DEFAULTCENTERLON=24.830819
      - TAR1090_ZOOM=12

  # ---------------------------------------------------------------------------
  # 3. LOGIC ENGINES
  # ---------------------------------------------------------------------------

  adsb-feeders:
    build: ./adsb-feeders
    container_name: adsb-feeders
    restart: always
    depends_on:
      - influxdb
    environment:
      - INFLUX_HOST=http://influxdb:8086
      - INFLUX_HOST_NAME=influxdb
      - INFLUX_DB=readsb

  fr24-poller:
    build: ./fr24-poller
    restart: always
    depends_on:
      - influxdb
    environment:
      - INFLUX_HOST=influxdb 
      - INFLUX_PORT=8086

  spoof-detector:
    build: ./spoof-detector
    restart: always
    depends_on:
      - influxdb
      - mqtt
    environment:
      - INFLUX_HOST=influxdb
      - INFLUX_PORT=8086
      - MQTT_HOST=mqtt
      - MQTT_PORT=1883

  physics-guard:
    build: ./physics-guard
    restart: always
    depends_on:
      - influxdb
      - mqtt
    environment:
      - INFLUX_HOST=influxdb 
      - INFLUX_PORT=8086
      - MQTT_HOST=mqtt
      - MQTT_PORT=1883

  runway-tracker:
    build: ./runway-tracker
    restart: always
    depends_on:
      - influxdb
      - mqtt
    environment:
      - INFLUX_HOST=influxdb 
      - INFLUX_PORT=8086
      - MQTT_HOST=mqtt
      - MQTT_PORT=1883
